#define _XTAL_FREQ 16000000

#include <xc.h>
#include <limits.h>
#include <pic16f1823.h>
#include "configbits.h"
#include "led_driver.h"

//const char message[] = { 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 1, 1, 1, 2, 1, 3, 1, 4, 1, 5, 255, 255, 255, 255, 255, 255, 255, 255, 2, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 3, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 4, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 5, 3, 255, 255, 255, 255, 255, 255, 255, 255, 6, 1, 6, 2, 6, 3, 6, 4, 6, 5, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 1, 9, 255, 255, 1, 11, 255, 255, 255, 255, 255, 255, 2, 8, 255, 255, 2, 10, 255, 255, 2, 12, 255, 255, 3, 7, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 3, 13, 255, 255, 4, 8, 255, 255, 255, 255, 255, 255, 4, 12, 255, 255, 255, 255, 255, 255, 5, 9, 255, 255, 5, 11, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 6, 10, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 };
const char message[] = { 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 1, 1, 1, 2, 1, 3, 1, 4, 1, 5, 255, 255, 255, 255, 255, 255, 255, 255, 2, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 3, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 4, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 5, 3, 255, 255, 255, 255, 255, 255, 255, 255, 6, 1, 6, 2, 6, 3, 6, 4, 6, 5, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 1, 2, 255, 255, 1, 4, 255, 255, 255, 255, 255, 255, 2, 1, 255, 255, 2, 3, 255, 255, 2, 5, 255, 255, 3, 0, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 3, 6, 255, 255, 4, 1, 255, 255, 255, 255, 255, 255, 4, 5, 255, 255, 255, 255, 255, 255, 5, 2, 255, 255, 5, 4, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 6, 3, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 1, 1, 255, 255, 255, 255, 255, 255, 1, 5, 255, 255, 255, 255, 2, 1, 255, 255, 255, 255, 255, 255, 2, 5, 255, 255, 255, 255, 3, 1, 255, 255, 255, 255, 255, 255, 3, 5, 255, 255, 255, 255, 4, 1, 255, 255, 255, 255, 255, 255, 4, 5, 255, 255, 255, 255, 5, 1, 255, 255, 255, 255, 255, 255, 5, 5, 255, 255, 255, 255, 255, 255, 6, 2, 6, 3, 6, 4, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 };
void main() {
    // Setting configuration and clearing ports.
    OSCCON = 0x78;
    ANSELA = 0x0;
    ANSELC = 0x0;
    PORTC = 0x0;
    PORTA = 0x0;
    TRISC = 0xff;
    TRISA = 0xff;

    unsigned int advance = 0;
    unsigned int total = sizeof(message)/sizeof(char);
    while (1)
    {
        if (advance + 1 >= total)
        {
            advance = 0;
            TRISA = 0xff;
            TRISC = 0xff;
        }

        // Hold for x number of seconds...
        if (advance % 112 == 0)
        {
            unsigned int count = 250;
            while (count-- > 1)
            {
                for (unsigned int i = advance; i < advance + 112; i+=2)
                {
                    //char newX = message[i] - c < 0 ? 0 : message[i] - c;

                    if (i + 1 >= total || message[i] == 255)
                    {
                        TRISA = 0xff;
                        TRISC = 0xff;
                    }
                    else
                    {
                        signed char newY = (signed char)message[i + 1]; // - (signed char)c;
                        if (newY >= 0)
                        {
                            display_led(&message[i], &newY);
                        }
                    }
                    __delay_us(75);
                }
            }
        }

        // Transition
        unsigned int count = 5;
        while (count-- > 1)
        {
            for (unsigned int i = advance; i < advance + 112; i+=2)
            {
                //char newX = message[i] - c < 0 ? 0 : message[i] - c;

                if (i + 1 >= total || message[i] == 255)
                {
                    TRISA = 0xff;
                    TRISC = 0xff;
                }
                else
                {
                    signed char newY = (signed char)message[i + 1]; // - (signed char)c;
                    if (newY >= 0)
                    {
                        display_led(&message[i], &newY);
                    }
                }
                __delay_us(75);
            }
        }
        advance += 2;
    }
}
